<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json?v={{.Version}}">
    <title>{{.Title}}</title>
    <link rel="stylesheet" href="/static/fonts/inter.css?v={{.Version}}">
    <link rel="stylesheet" href="/static/css/dashgate.css?v={{.Version}}">
</head>
<body>
    <div class="bg-gradient"></div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1 class="greeting">Welcome, {{.User}}</h1>
            <div class="user-avatar">{{slice .User 0 1}}</div>
        </header>

        <!-- Main Layout with Sidebar -->
        <div class="main-layout">
            <!-- Main Content -->
            <main class="main-content">
                <!-- Favorites -->
        <div class="favorites-bar" id="favoritesBar" style="display: none;">
        </div>

        <!-- App Categories -->
        {{if not .Categories}}
        <div class="empty-state">
            <div class="empty-state-icon">
                <svg width="40" height="40" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                    <path d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                </svg>
            </div>
            <h2 class="empty-state-title">No apps available</h2>
            <p class="empty-state-desc">Contact your administrator for access</p>
        </div>
        {{else}}
        {{range $catIndex, $cat := .Categories}}
        <div class="category-section" data-category="{{$cat.Name}}">
            <div class="category-header">
                <h2 class="category-name">{{$cat.Name}}</h2>
                <span class="category-count">{{len $cat.Apps}}</span>
            </div>
            <div class="app-grid">
                {{range $app := $cat.Apps}}
                <a href="{{$app.URL}}" target="_blank" rel="noopener" class="app-item"
                   data-name="{{$app.Name}}"
                   data-url="{{$app.URL}}"
                   data-desc="{{$app.Description}}"
                   data-icon="{{$app.Icon}}"
                   data-status="{{$app.Status}}">
                    <div class="app-icon-wrapper">
                        <div class="app-icon">
                            {{if $app.Icon}}
                            <img src="/static/icons/{{$app.Icon}}" alt="{{$app.Name}}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <span class="app-icon-fallback" style="display:none;">{{slice $app.Name 0 1}}</span>
                            {{else}}
                            <span class="app-icon-fallback">{{slice $app.Name 0 1}}</span>
                            {{end}}
                        </div>
                        <div class="app-status {{$app.Status}}"></div>
                    </div>
                    <span class="app-name">{{$app.Name}}</span>
                </a>
                {{end}}
            </div>
        </div>
        {{end}}
        {{end}}
            </main>
            <!-- End Main Content -->

            <!-- Widgets Sidebar -->
            <div class="widgets-sidebar">
                <div class="widgets-section">
                    <div class="widget" data-widget="services">
                        <div class="widget-header">
                            <div class="widget-icon" style="background: linear-gradient(135deg, #30d158, #34c759);">
                                <svg width="20" height="20" fill="white" viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                </svg>
                            </div>
                            <span class="widget-title">Services</span>
                        </div>
                        <div class="status-grid">
                            <div class="status-item">
                                <div class="status-count" style="color: var(--green);" id="onlineCount">0</div>
                                <div class="status-label">Online</div>
                            </div>
                            <div class="status-item">
                                <div class="status-count" style="color: var(--red);" id="offlineCount">0</div>
                                <div class="status-label">Offline</div>
                            </div>
                            <div class="status-item">
                                <div class="status-count" id="totalCount">0</div>
                                <div class="status-label">Total</div>
                            </div>
                        </div>
                    </div>

                    <div class="widget" data-widget="system">
                        <div class="widget-header">
                            <div class="widget-icon" style="background: linear-gradient(135deg, #ff9f0a, #ff375f);">
                                <svg width="20" height="20" fill="white" viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                                </svg>
                            </div>
                            <span class="widget-title">System</span>
                        </div>
                        <div class="widget-value" id="currentTime">--:--</div>
                        <div class="widget-subtitle" id="currentDate">Loading...</div>
                    </div>

                    <!-- Weather Widget -->
                    <div class="widget" id="weatherWidget" data-widget="weather">
                        <div class="widget-header">
                            <div class="widget-icon" style="background: linear-gradient(135deg, #5ac8fa, #007aff);">
                                <svg width="20" height="20" fill="white" viewBox="0 0 24 24">
                                    <path d="M12 2a5 5 0 00-5 5c0 .76.17 1.48.47 2.12A6 6 0 003 15a6 6 0 006 6h9a5 5 0 005-5c0-2.18-1.41-4.04-3.36-4.72A5 5 0 0012 2z"/>
                                </svg>
                            </div>
                            <span class="widget-title">Weather</span>
                        </div>
                        <div id="weatherContent">
                            <div class="weather-setup">
                                <input type="text" id="weatherCity" placeholder="Enter city name...">
                                <button onclick="searchWeatherCity()">Set Location</button>
                            </div>
                        </div>
                    </div>

                    <!-- Notes Widget -->
                    <div class="widget notes-widget" data-widget="notes">
                        <div class="widget-header">
                            <div class="widget-icon" style="background: linear-gradient(135deg, #ffd60a, #ff9f0a);">
                                <svg width="20" height="20" fill="white" viewBox="0 0 24 24">
                                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                                </svg>
                            </div>
                            <span class="widget-title">Quick Notes</span>
                        </div>
                        <textarea class="notes-textarea" id="quickNotes" placeholder="Type your notes here..." onchange="saveQuickNotes()"></textarea>
                        <div class="notes-footer">
                            <span id="notesCharCount">0 characters</span>
                            <span id="notesSaved" style="color: var(--green); opacity: 0;">Saved</span>
                        </div>
                    </div>

                    <!-- Quick Links Widget -->
                    <div class="widget" data-widget="quicklinks">
                        <div class="widget-header">
                            <div class="widget-icon" style="background: linear-gradient(135deg, #bf5af2, #5856d6);">
                                <svg width="20" height="20" fill="white" viewBox="0 0 24 24">
                                    <path d="M17 7h-4v2h4c1.65 0 3 1.35 3 3s-1.35 3-3 3h-4v2h4c2.76 0 5-2.24 5-5s-2.24-5-5-5zm-6 8H7c-1.65 0-3-1.35-3-3s1.35-3 3-3h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-2zm-3-4h8v2H8z"/>
                                </svg>
                            </div>
                            <span class="widget-title">Quick Links</span>
                        </div>
                        <div class="quick-links-list" id="quickLinksList">
                            <div class="quick-links-empty">No quick links yet</div>
                        </div>
                        <button class="quick-links-add" onclick="openQuickLinkModal()">
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M12 5v14M5 12h14"/>
                            </svg>
                            Add Link
                        </button>
                    </div>
                </div>
            </div>
            <!-- End Widgets Sidebar -->
        </div>
        <!-- End Main Layout -->
    </div>

    <!-- Dock -->
    <nav class="dock" aria-label="Application dock">
        <div class="dock-item active" onclick="scrollToTop()" title="Home">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
            </svg>
        </div>
        <div class="dock-item" onclick="openSearch()" title="Search">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="7"/><path d="M21 21l-4-4"/>
            </svg>
        </div>
        <div class="dock-divider"></div>
        <div class="dock-item" onclick="toggleFavoritesView()" title="Favorites">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
        </div>
        <div class="dock-item" onclick="openDepsModal()" title="Dependencies">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <circle cx="18" cy="5" r="3"/>
                <circle cx="6" cy="12" r="3"/>
                <circle cx="18" cy="19" r="3"/>
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
            </svg>
        </div>
        <div class="dock-item" onclick="openSettings()" title="Settings">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="3"/>
                <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
            </svg>
        </div>
        <div class="dock-item" onclick="refreshHealth()" title="Refresh Status">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M23 4v6h-6M1 20v-6h6"/>
                <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
            </svg>
        </div>
    </nav>

    <!-- Search Modal -->
    <div class="search-modal" id="searchModal" role="dialog" aria-modal="true" aria-label="Search applications">
        <div class="search-backdrop" onclick="closeSearch()"></div>
        <div class="search-container">
            <div class="search-input-wrapper">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="7"/><path d="M21 21l-4-4"/>
                </svg>
                <input type="text" class="search-input" id="searchInput" placeholder="Search apps..." autocomplete="off">
            </div>
            <div class="search-results" id="searchResults"></div>
            <div class="search-hint">
                <span><span class="kbd">↑↓</span> Navigate</span>
                <span><span class="kbd">↵</span> Open</span>
                <span><span class="kbd">esc</span> Close</span>
            </div>
        </div>
    </div>

    <!-- Dependencies Modal -->
    <div class="deps-modal" id="depsModal" role="dialog" aria-modal="true" aria-label="Dependencies">
        <div class="deps-backdrop" onclick="closeDepsModal()"></div>
        <div class="deps-container">
            <div class="deps-header">
                <h2>Service Dependencies</h2>
                <button class="deps-close" onclick="closeDepsModal()">&times;</button>
            </div>
            <div class="deps-content">
                <div class="deps-search">
                    <input type="text" id="depsSearch" placeholder="Search services..." oninput="filterDeps(this.value)">
                </div>
                <div class="deps-graph" id="depsGraph">
                    <div class="deps-empty">Loading dependencies...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu" role="menu">
        <div class="context-item" data-action="open" role="menuitem">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/>
                <polyline points="15 3 21 3 21 9"/>
                <line x1="10" y1="14" x2="21" y2="3"/>
            </svg>
            Open in new tab
        </div>
        <div class="context-item" data-action="copy" role="menuitem">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/>
            </svg>
            Copy URL
        </div>
        <div class="context-item" data-action="favorite" role="menuitem">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>
            <span id="contextFavText">Add to favorites</span>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal" role="dialog" aria-modal="true" aria-label="Settings">
        <div class="settings-backdrop" onclick="closeSettings()"></div>
        <div class="settings-container">
            <div class="settings-header">
                <h2 class="settings-title">Settings</h2>
                <button class="settings-close" onclick="closeSettings()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- User Profile Section -->
            <div class="settings-user" id="settingsUserSection" style="display: none;">
                <div class="settings-user-avatar" id="settingsUserAvatar">U</div>
                <div class="settings-user-info">
                    <div class="settings-user-name" id="settingsUserName">User</div>
                    <div class="settings-user-meta">
                        <span id="settingsUserSource">Local</span>
                        <span>|</span>
                        <span class="settings-sync-status" id="settingsSyncStatus">
                            <span class="settings-sync-dot"></span>
                            <span>Synced</span>
                        </span>
                    </div>
                </div>
                <button class="settings-logout-btn" onclick="logoutUser()">Log out</button>
            </div>

            <div class="settings-tabs">
                <button class="settings-tab active" data-tab="general" title="General">
                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
                    </svg>
                </button>
                <button class="settings-tab" data-tab="favorites" title="Favorites & Apps">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                </button>
                <button class="settings-tab" data-tab="advanced" title="Advanced">
                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <polyline points="16 18 22 12 16 6"/>
                        <polyline points="8 6 2 12 8 18"/>
                    </svg>
                </button>
                <button class="settings-tab" data-tab="admin" id="adminTab" style="display: none;" title="Admin">
                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    </svg>
                </button>
            </div>
            <div class="settings-content">
                <!-- General Tab (Appearance + Layout + Behavior) -->
                <div class="settings-panel active" data-panel="general">
                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div class="settings-section-icon">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="5"/>
                                    <line x1="12" y1="1" x2="12" y2="3"/>
                                    <line x1="12" y1="21" x2="12" y2="23"/>
                                </svg>
                            </div>
                            <div>
                                <div class="settings-section-title">Theme</div>
                                <div class="settings-section-desc">Choose your preferred color scheme</div>
                            </div>
                        </div>
                        <div class="settings-radio-group">
                            <label class="settings-radio">
                                <input type="radio" name="theme" value="dark">
                                <span class="radio-mark"></span>
                                <span>Dark</span>
                            </label>
                            <label class="settings-radio">
                                <input type="radio" name="theme" value="light">
                                <span class="radio-mark"></span>
                                <span>Light</span>
                            </label>
                            <label class="settings-radio">
                                <input type="radio" name="theme" value="system">
                                <span class="radio-mark"></span>
                                <span>System</span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div class="settings-section-icon">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M12 2.69l5.66 5.66a8 8 0 11-11.31 0z"/>
                                </svg>
                            </div>
                            <div>
                                <div class="settings-section-title">Accent Color</div>
                                <div class="settings-section-desc">Personalize buttons and highlights</div>
                            </div>
                        </div>
                        <div class="color-picker">
                            <button class="color-option" data-color="blue" style="--color: #0a84ff" title="Blue"></button>
                            <button class="color-option" data-color="purple" style="--color: #bf5af2" title="Purple"></button>
                            <button class="color-option" data-color="green" style="--color: #30d158" title="Green"></button>
                            <button class="color-option" data-color="orange" style="--color: #ff9f0a" title="Orange"></button>
                            <button class="color-option" data-color="pink" style="--color: #ff375f" title="Pink"></button>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div class="settings-section-icon">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                </svg>
                            </div>
                            <div>
                                <div class="settings-section-title">App Icons</div>
                                <div class="settings-section-desc">Adjust icon size and spacing</div>
                            </div>
                        </div>
                        <div class="settings-group" style="margin-bottom: 16px;">
                            <label class="settings-label" style="margin-bottom: 8px;">Icon Size</label>
                            <div class="settings-radio-group">
                                <label class="settings-radio">
                                    <input type="radio" name="iconSize" value="small">
                                    <span class="radio-mark"></span>
                                    <span>Small</span>
                                </label>
                                <label class="settings-radio">
                                    <input type="radio" name="iconSize" value="medium">
                                    <span class="radio-mark"></span>
                                    <span>Medium</span>
                                </label>
                                <label class="settings-radio">
                                    <input type="radio" name="iconSize" value="large">
                                    <span class="radio-mark"></span>
                                    <span>Large</span>
                                </label>
                            </div>
                        </div>
                        <div class="settings-group">
                            <label class="settings-label" style="margin-bottom: 8px;">Grid Density</label>
                            <div class="settings-radio-group">
                                <label class="settings-radio">
                                    <input type="radio" name="gridDensity" value="compact">
                                    <span class="radio-mark"></span>
                                    <span>Compact</span>
                                </label>
                                <label class="settings-radio">
                                    <input type="radio" name="gridDensity" value="comfortable">
                                    <span class="radio-mark"></span>
                                    <span>Comfortable</span>
                                </label>
                                <label class="settings-radio">
                                    <input type="radio" name="gridDensity" value="spacious">
                                    <span class="radio-mark"></span>
                                    <span>Spacious</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div class="settings-section-icon">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                            </div>
                            <div>
                                <div class="settings-section-title">Visibility</div>
                                <div class="settings-section-desc">Show or hide UI elements</div>
                            </div>
                        </div>
                        <div class="settings-row">
                            <div>
                                <label class="settings-label">Background Gradient</label>
                                <span class="settings-desc">Show gradient orbs in background</span>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="showGradient">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="settings-row">
                            <div>
                                <label class="settings-label">Show Widgets</label>
                                <span class="settings-desc">Display status widgets at top</span>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="showWidgets">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="settings-row">
                            <div>
                                <label class="settings-label">Status Indicators</label>
                                <span class="settings-desc">Show online/offline badges on apps</span>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="showStatus">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="settings-row">
                            <div>
                                <label class="settings-label">Category Headers</label>
                                <span class="settings-desc">Show section titles for app groups</span>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="showCategories">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="settings-row">
                            <div>
                                <label class="settings-label">Open in New Tab</label>
                                <span class="settings-desc">Open apps in a new browser tab</span>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="openInNewTab">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div class="settings-section-icon">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M23 4v6h-6M1 20v-6h6"/>
                                    <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                                </svg>
                            </div>
                            <div>
                                <div class="settings-section-title">Auto-Refresh</div>
                                <div class="settings-section-desc">Automatically refresh service status</div>
                            </div>
                        </div>
                        <div class="settings-radio-group">
                            <label class="settings-radio">
                                <input type="radio" name="autoRefresh" value="0">
                                <span class="radio-mark"></span>
                                <span>Off</span>
                            </label>
                            <label class="settings-radio">
                                <input type="radio" name="autoRefresh" value="30">
                                <span class="radio-mark"></span>
                                <span>30s</span>
                            </label>
                            <label class="settings-radio">
                                <input type="radio" name="autoRefresh" value="60">
                                <span class="radio-mark"></span>
                                <span>1m</span>
                            </label>
                            <label class="settings-radio">
                                <input type="radio" name="autoRefresh" value="300">
                                <span class="radio-mark"></span>
                                <span>5m</span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div class="settings-section-icon">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <rect x="3" y="3" width="7" height="7" rx="1"/>
                                    <rect x="14" y="3" width="7" height="7" rx="1"/>
                                    <rect x="3" y="14" width="7" height="7" rx="1"/>
                                    <rect x="14" y="14" width="7" height="7" rx="1"/>
                                </svg>
                            </div>
                            <div>
                                <h4>Widgets</h4>
                                <span class="settings-section-subtitle">Toggle and reorder sidebar widgets</span>
                            </div>
                        </div>
                        <div class="widget-config-list" id="widgetConfigList"></div>
                    </div>

                    <div class="settings-footer">
                        <button class="settings-reset-btn" onclick="resetGeneralSettings()">
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M3 12a9 9 0 109-9 9.75 9.75 0 00-6.74 2.74L3 8"/>
                                <path d="M3 3v5h5"/>
                            </svg>
                            Reset to Defaults
                        </button>
                    </div>
                </div>

                <!-- Favorites & Apps Tab -->
                <div class="settings-panel" data-panel="favorites">
                    <div class="settings-group">
                        <div class="settings-row">
                            <label class="settings-label">Your Favorites</label>
                            <div class="favorites-actions">
                                <button class="settings-btn-small" onclick="clearAllFavorites()">Clear All</button>
                            </div>
                        </div>
                        <p class="settings-desc" style="margin-bottom: 12px;">Drag to reorder, click X to remove</p>
                        <div class="favorites-list" id="favoritesList"></div>
                        <div class="favorites-empty" id="favoritesEmpty">
                            <svg width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                            <p>No favorites yet</p>
                            <span>Right-click an app to add it</span>
                        </div>
                    </div>
                    <div class="settings-divider"></div>
                    <div class="settings-group">
                        <div class="settings-row">
                            <label class="settings-label">My Personal Apps</label>
                            <button class="settings-btn" onclick="openMyAppModal()" style="padding: 6px 12px; font-size: 12px;">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M12 5v14M5 12h14"/>
                                </svg>
                                Add
                            </button>
                        </div>
                        <p class="settings-desc" style="margin-bottom: 12px;">Add your own apps and websites. Stored in your browser.</p>
                        <div class="favorites-list" id="myAppsList">
                        </div>
                        <div class="favorites-empty" id="myAppsEmpty">
                            <svg width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                                <rect x="3" y="3" width="7" height="7"/>
                                <rect x="14" y="3" width="7" height="7"/>
                                <rect x="14" y="14" width="7" height="7"/>
                                <rect x="3" y="14" width="7" height="7"/>
                            </svg>
                            <p>No personal apps yet</p>
                            <span>Click "Add" to create one</span>
                        </div>
                    </div>
                    <div class="settings-divider"></div>
                    <div class="settings-group">
                        <label class="settings-label">Import / Export</label>
                        <p class="settings-desc" style="margin-bottom: 12px;">Backup or restore all settings as JSON</p>
                        <div class="settings-btn-row">
                            <button class="settings-btn" onclick="exportSettings()">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                                </svg>
                                Export All
                            </button>
                            <button class="settings-btn" onclick="document.getElementById('importInput').click()">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                                </svg>
                                Import All
                            </button>
                            <input type="file" id="importInput" accept=".json" style="display:none" onchange="importSettings(event)">
                            <button class="settings-btn" onclick="exportMyApps()">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                                </svg>
                                Export Apps
                            </button>
                            <button class="settings-btn" onclick="document.getElementById('myAppsImportInput').click()">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                                </svg>
                                Import Apps
                            </button>
                            <input type="file" id="myAppsImportInput" accept=".json" style="display:none" onchange="importMyApps(event)">
                        </div>
                    </div>
                </div>

                <!-- Advanced Tab -->
                <div class="settings-panel" data-panel="advanced">
                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div class="settings-section-icon">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <polyline points="16 18 22 12 16 6"/>
                                    <polyline points="8 6 2 12 8 18"/>
                                </svg>
                            </div>
                            <div>
                                <div class="settings-section-title">Custom CSS</div>
                                <div class="settings-section-desc">Add your own styles to customize DashGate</div>
                            </div>
                        </div>
                        <div class="custom-css-container">
                            <textarea id="customCSSInput" class="custom-css-textarea" placeholder="/* Enter your custom CSS here */&#10;&#10;/* Example: Change header color */&#10;.header {&#10;    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);&#10;}&#10;&#10;/* Example: Make app icons rounder */&#10;.app-icon {&#10;    border-radius: 24px;&#10;}" spellcheck="false"></textarea>
                            <div class="custom-css-actions">
                                <button class="settings-btn" onclick="applyCustomCSSFromInput()">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    Apply
                                </button>
                                <button class="settings-btn secondary" onclick="clearCustomCSS()">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                    </svg>
                                    Clear
                                </button>
                            </div>
                        </div>
                        <p class="settings-desc" style="margin-top: 12px;">
                            <strong>Tip:</strong> Use CSS variables like <code>var(--accent)</code>, <code>var(--bg-secondary)</code>, etc. for theme-aware styling.
                        </p>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div class="settings-section-icon">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                                </svg>
                            </div>
                            <div>
                                <div class="settings-section-title">CSS Snippets</div>
                                <div class="settings-section-desc">One-click presets to customize DashGate</div>
                            </div>
                        </div>
                        <div class="css-snippets-grid" id="cssSnippetsGrid"></div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div class="settings-section-icon">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/>
                                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                                </svg>
                            </div>
                            <div>
                                <div class="settings-section-title">CSS Reference</div>
                                <div class="settings-section-desc">Theme variables and element selectors you can target</div>
                            </div>
                        </div>
                        <div class="css-variables-reference">
                            <div class="css-var-group">
                                <div class="css-var-title">Theme Variables</div>
                            </div>
                            <div class="css-var-group">
                                <div class="css-var-title">Backgrounds</div>
                                <code>--bg-primary</code> <code>--bg-secondary</code> <code>--bg-tertiary</code> <code>--bg-elevated</code>
                            </div>
                            <div class="css-var-group">
                                <div class="css-var-title">Text</div>
                                <code>--text-primary</code> <code>--text-secondary</code> <code>--text-tertiary</code>
                            </div>
                            <div class="css-var-group">
                                <div class="css-var-title">Accent</div>
                                <code>--accent</code> <code>--accent-hover</code>
                            </div>
                            <div class="css-var-group">
                                <div class="css-var-title">UI Elements</div>
                                <code>--border</code> <code>--shadow</code> <code>--modal-bg</code>
                                <code>--input-bg</code> <code>--toggle-bg</code> <code>--toggle-active</code>
                            </div>
                            <div class="css-var-group">
                                <div class="css-var-title">Status Colors</div>
                                <code>--green</code> <code>--red</code> <code>--orange</code>
                            </div>
                        </div>
                        <div class="css-variables-reference" style="margin-top: 8px;">
                            <div class="css-var-group">
                                <div class="css-var-title">Element Selectors</div>
                            </div>
                            <div class="css-var-group">
                                <div class="css-var-title">Apps</div>
                                <code>.app-item</code> <code>.app-icon</code> <code>.app-name</code> <code>.app-status</code> <code>.app-grid</code>
                            </div>
                            <div class="css-var-group">
                                <div class="css-var-title">Categories</div>
                                <code>.category-section</code> <code>.category-header</code> <code>.category-name</code> <code>.category-count</code>
                            </div>
                            <div class="css-var-group">
                                <div class="css-var-title">Widgets</div>
                                <code>.widget</code> <code>.widget-header</code> <code>.widget-icon</code> <code>.widget-title</code> <code>.widget-value</code>
                            </div>
                            <div class="css-var-group">
                                <div class="css-var-title">Layout</div>
                                <code>.widgets-sidebar</code> <code>.main-content</code> <code>.main-layout</code> <code>.container</code>
                            </div>
                            <div class="css-var-group">
                                <div class="css-var-title">Header &amp; Nav</div>
                                <code>.header</code> <code>.greeting</code> <code>.user-avatar</code> <code>.dock</code> <code>.dock-item</code>
                            </div>
                            <div class="css-var-group">
                                <div class="css-var-title">Search</div>
                                <code>.search-modal</code> <code>.search-container</code> <code>.search-input</code> <code>.search-result</code>
                            </div>
                            <div class="css-var-group">
                                <div class="css-var-title">Favorites</div>
                                <code>.favorites-bar</code> <code>.favorite-chip</code> <code>.favorite-chip-icon</code> <code>.favorite-chip-name</code>
                            </div>
                            <div class="css-var-group">
                                <div class="css-var-title">Background</div>
                                <code>.bg-gradient</code> <code>body</code>
                            </div>
                        </div>
                    </div>

                    <div class="settings-footer">
                        <button class="settings-reset-btn" onclick="resetAdvancedSettings()">
                            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M3 12a9 9 0 109-9 9.75 9.75 0 00-6.74 2.74L3 8"/>
                                <path d="M3 3v5h5"/>
                            </svg>
                            Reset to Defaults
                        </button>
                    </div>
                </div>

                <!-- Admin Tab -->
                <div class="settings-panel" data-panel="admin">
                    <!-- Admin Sub-Tabs -->
                    <div class="admin-subtabs">
                        <button class="admin-subtab active" data-admin-tab="content">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                                <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                            </svg>
                            <span>Content</span>
                        </button>
                        <button class="admin-subtab" data-admin-tab="users">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            <span>Users</span>
                        </button>
                        <button class="admin-subtab" data-admin-tab="auth">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            </svg>
                            <span>Auth</span>
                        </button>
                        <button class="admin-subtab" data-admin-tab="discovery">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                            </svg>
                            <span>Discovery</span>
                        </button>
                    </div>

                    <!-- Auth Sub-Panel -->
                    <div class="admin-subpanel" data-admin-panel="auth">

                    <!-- Security Warning Banner -->
                    <div id="proxyAuthWarning" style="display: none; background: rgba(255, 159, 10, 0.1); border: 1px solid var(--orange); border-radius: 10px; padding: 12px 16px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: flex-start; gap: 10px;">
                            <svg style="flex-shrink: 0; color: var(--orange); margin-top: 1px;" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                            <div>
                                <div style="font-weight: 600; font-size: 13px; color: var(--orange); margin-bottom: 4px;">Proxy Auth Misconfiguration</div>
                                <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.5;">Reverse Proxy Auth is enabled but no Trusted Proxy IPs are configured. Auth headers from all sources will be rejected. Add your reverse proxy's IP address or CIDR range below.</div>
                            </div>
                        </div>
                    </div>

                    <!-- System Settings -->
                    <div class="admin-section" id="systemSettingsSection">
                        <div class="admin-section-header">
                            <h3 class="admin-section-title">System Settings</h3>
                        </div>
                        <p class="settings-desc" style="margin-bottom: 16px;">Configure authentication providers and session behavior</p>

                        <!-- General Session Settings -->
                        <div class="settings-row">
                            <div class="settings-label">
                                <span>Session Duration
                                    <span class="help-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
                                        </svg>
                                        <span class="tooltip">How long users stay logged in before needing to re-authenticate. Longer is more convenient, shorter is more secure. Default: 7 days.</span>
                                    </span>
                                </span>
                                <span class="settings-hint">Days until login expires</span>
                            </div>
                            <input type="number" id="systemSessionDays" class="settings-input-small" value="7" min="1" max="365" onchange="markSystemConfigDirty()">
                        </div>

                        <div class="settings-row">
                            <div class="settings-label">
                                <span>Secure Cookies
                                    <span class="help-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
                                        </svg>
                                        <span class="tooltip">Enable if using HTTPS. Prevents session cookies from being sent over insecure connections. Disable for local HTTP testing.</span>
                                    </span>
                                </span>
                                <span class="settings-hint">Require HTTPS for session cookies</span>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="systemCookieSecure" checked onchange="markSystemConfigDirty()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div class="settings-row">
                            <div class="settings-label">
                                <span>Admin Groups
                                    <span class="help-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
                                        </svg>
                                        <span class="tooltip">Comma-separated list of group names that grant admin access. Users in any of these groups will have admin privileges across all authentication methods.</span>
                                    </span>
                                </span>
                                <span class="settings-hint">Groups that grant admin privileges</span>
                            </div>
                            <input type="text" id="systemAdminGroup" class="settings-input" style="width: 240px;" placeholder="admin" onchange="markSystemConfigDirty()">
                        </div>

                        <div class="settings-divider" style="margin: 16px 0;"></div>

                        <!-- Auth Providers -->
                        <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text-secondary);">Authentication Providers</h4>
                        <p class="settings-desc" style="margin-bottom: 12px;">Enable one or more authentication methods</p>

                        <!-- Proxy Auth (Authelia) -->
                        <div class="settings-row">
                            <div class="settings-label">
                                <span>Reverse Proxy Auth
                                    <span class="help-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
                                        </svg>
                                        <span class="tooltip">Trusts authentication headers from a reverse proxy (Authelia, Authentik, Traefik Forward Auth). Only enable if running behind such a proxy.</span>
                                    </span>
                                </span>
                                <span class="settings-hint">Authelia, Authentik, or similar (Remote-User header)</span>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="systemProxyAuth" onchange="markSystemConfigDirty(); toggleTrustedProxiesSection()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <!-- Trusted Proxies (shown when proxy auth enabled) -->
                        <div id="trustedProxiesSection" class="auth-config-section" style="display: none;">
                            <div class="auth-config-inner">
                                <div class="settings-row">
                                    <div class="settings-label">
                                        <span>Trusted Proxy IPs
                                            <span class="help-icon">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
                                                </svg>
                                                <span class="tooltip">Comma-separated list of IP addresses or CIDR ranges allowed to send authentication headers. Empty means no sources are trusted (proxy auth will not work). Example: 172.16.0.0/12,10.0.0.0/8,192.168.0.0/16</span>
                                            </span>
                                        </span>
                                        <span class="settings-hint">IPs/CIDRs allowed to send auth headers (required for proxy auth)</span>
                                    </div>
                                    <input type="text" id="systemTrustedProxies" class="settings-input" style="width: 280px;" placeholder="172.16.0.0/12, 10.0.0.0/8" oninput="updateProxyAuthWarning()" onchange="markSystemConfigDirty()">
                                </div>
                            </div>
                        </div>

                        <!-- Local Auth -->
                        <div class="settings-row">
                            <div class="settings-label">
                                <span>Local Users
                                    <span class="help-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
                                        </svg>
                                        <span class="tooltip">User accounts stored in DashGate's local database. Good for small deployments without external authentication systems.</span>
                                    </span>
                                </span>
                                <span class="settings-hint">Built-in user accounts stored in local database</span>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="systemLocalAuth" onchange="markSystemConfigDirty(); toggleLocalAuthSection()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <!-- LDAP Auth -->
                        <div class="settings-row">
                            <div class="settings-label">
                                <span>LDAP Authentication
                                    <span class="help-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
                                        </svg>
                                        <span class="tooltip">Authenticate users against an LDAP or Active Directory server. Users log in with their directory credentials.</span>
                                    </span>
                                </span>
                                <span class="settings-hint">Authenticate against LDAP/Active Directory</span>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="systemLDAPAuth" onchange="markSystemConfigDirty(); toggleLDAPSection()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <!-- LDAP Configuration (collapsible) -->
                        <div id="ldapConfigSection" class="auth-config-section" style="display: none;">
                            <div class="auth-config-inner">
                                <div class="admin-form-group">
                                    <label for="ldapServer">LDAP Server URL *</label>
                                    <input type="text" id="ldapServer" class="admin-input" placeholder="ldap://localhost:389 or ldaps://ldap.example.com:636" onchange="markSystemConfigDirty()">
                                </div>
                                <div class="admin-form-row">
                                    <div class="admin-form-group" style="flex: 1;">
                                        <label for="ldapBindDN">Bind DN *</label>
                                        <input type="text" id="ldapBindDN" class="admin-input" placeholder="cn=admin,dc=example,dc=com" onchange="markSystemConfigDirty()">
                                    </div>
                                    <div class="admin-form-group" style="flex: 1;">
                                        <label for="ldapBindPassword">Bind Password *</label>
                                        <input type="password" id="ldapBindPassword" class="admin-input" placeholder="Leave blank to keep current" onchange="markSystemConfigDirty()">
                                    </div>
                                </div>
                                <div class="admin-form-group">
                                    <label for="ldapBaseDN">Base DN *</label>
                                    <input type="text" id="ldapBaseDN" class="admin-input" placeholder="dc=example,dc=com" onchange="markSystemConfigDirty()">
                                </div>
                                <div class="admin-form-row">
                                    <div class="admin-form-group" style="flex: 1;">
                                        <label for="ldapUserFilter">User Filter</label>
                                        <input type="text" id="ldapUserFilter" class="admin-input" placeholder="(uid=%s)" onchange="markSystemConfigDirty()">
                                    </div>
                                    <div class="admin-form-group" style="flex: 1;">
                                        <label for="ldapGroupFilter">Group Filter</label>
                                        <input type="text" id="ldapGroupFilter" class="admin-input" placeholder="(memberUid=%s)" onchange="markSystemConfigDirty()">
                                    </div>
                                </div>
                                <div class="admin-form-row">
                                    <div class="admin-form-group" style="flex: 1;">
                                        <label for="ldapUserAttr">Username Attr</label>
                                        <input type="text" id="ldapUserAttr" class="admin-input" placeholder="uid" onchange="markSystemConfigDirty()">
                                    </div>
                                    <div class="admin-form-group" style="flex: 1;">
                                        <label for="ldapEmailAttr">Email Attr</label>
                                        <input type="text" id="ldapEmailAttr" class="admin-input" placeholder="mail" onchange="markSystemConfigDirty()">
                                    </div>
                                </div>
                                <div class="admin-form-row">
                                    <div class="admin-form-group" style="flex: 1;">
                                        <label for="ldapDisplayAttr">Display Name Attr</label>
                                        <input type="text" id="ldapDisplayAttr" class="admin-input" placeholder="cn" onchange="markSystemConfigDirty()">
                                    </div>
                                    <div class="admin-form-group" style="flex: 1;">
                                        <label for="ldapGroupAttr">Group Attr</label>
                                        <input type="text" id="ldapGroupAttr" class="admin-input" placeholder="memberOf" onchange="markSystemConfigDirty()">
                                    </div>
                                </div>
                                <div class="settings-row" style="padding: 0;">
                                    <div class="settings-label" style="flex: 1;">
                                        <span>StartTLS</span>
                                        <span class="settings-hint">Upgrade to TLS after connecting</span>
                                    </div>
                                    <label class="toggle">
                                        <input type="checkbox" id="ldapStartTLS" onchange="markSystemConfigDirty()">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="settings-row" style="padding: 0; padding-top: 8px;">
                                    <div class="settings-label" style="flex: 1;">
                                        <span>Skip TLS Verify</span>
                                        <span class="settings-hint">Allow self-signed certificates (not recommended)</span>
                                    </div>
                                    <label class="toggle">
                                        <input type="checkbox" id="ldapSkipVerify" onchange="markSystemConfigDirty()">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- OIDC Auth -->
                        <div class="settings-row">
                            <div class="settings-label">
                                <span>OIDC / OAuth2
                                    <span class="help-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
                                        </svg>
                                        <span class="tooltip">Single sign-on via OpenID Connect. Works with Keycloak, Auth0, Okta, Google, and other OIDC providers.</span>
                                    </span>
                                </span>
                                <span class="settings-hint">OpenID Connect single sign-on</span>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="systemOIDCAuth" onchange="markSystemConfigDirty(); toggleOIDCSection()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <!-- OIDC Configuration (collapsible) -->
                        <div id="oidcConfigSection" class="auth-config-section" style="display: none;">
                            <div class="auth-config-inner">
                                <div class="admin-form-group">
                                    <label for="oidcIssuer">Issuer URL *</label>
                                    <input type="url" id="oidcIssuer" class="admin-input" placeholder="https://auth.example.com" onchange="markSystemConfigDirty()">
                                    <p class="settings-desc" style="margin-top: 4px;">The OIDC provider's issuer URL (e.g., Keycloak realm URL)</p>
                                </div>
                                <div class="admin-form-row">
                                    <div class="admin-form-group" style="flex: 1;">
                                        <label for="oidcClientID">Client ID *</label>
                                        <input type="text" id="oidcClientID" class="admin-input" placeholder="dashgate" onchange="markSystemConfigDirty()">
                                    </div>
                                    <div class="admin-form-group" style="flex: 1;">
                                        <label for="oidcClientSecret">Client Secret *</label>
                                        <input type="password" id="oidcClientSecret" class="admin-input" placeholder="Leave blank to keep current" onchange="markSystemConfigDirty()">
                                    </div>
                                </div>
                                <div class="admin-form-group">
                                    <label for="oidcRedirectURL">Redirect URL *</label>
                                    <input type="url" id="oidcRedirectURL" class="admin-input" placeholder="https://dashgate.example.com/auth/oidc/callback" onchange="markSystemConfigDirty()">
                                    <p class="settings-desc" style="margin-top: 4px;">Must be registered with your OIDC provider</p>
                                </div>
                                <div class="admin-form-row">
                                    <div class="admin-form-group" style="flex: 1;">
                                        <label for="oidcScopes">Scopes</label>
                                        <input type="text" id="oidcScopes" class="admin-input" placeholder="openid profile email groups" onchange="markSystemConfigDirty()">
                                    </div>
                                    <div class="admin-form-group" style="flex: 1;">
                                        <label for="oidcGroupsClaim">Groups Claim</label>
                                        <input type="text" id="oidcGroupsClaim" class="admin-input" placeholder="groups" onchange="markSystemConfigDirty()">
                                        <p class="settings-desc" style="margin-top: 4px; font-size: 11px;">Claim containing group membership</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- API Keys -->
                        <div class="settings-row">
                            <div class="settings-label">
                                <span>API Key Authentication
                                    <span class="help-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
                                        </svg>
                                        <span class="tooltip">Allow scripts and automation to access the DashGate API using bearer tokens. Create and manage keys in the section below.</span>
                                    </span>
                                </span>
                                <span class="settings-hint">Allow programmatic access via API keys</span>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="systemAPIKeys" onchange="markSystemConfigDirty(); toggleAPIKeySection()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div style="margin-top: 16px;">
                            <button class="settings-btn admin-btn-primary" id="saveSystemConfig" onclick="saveSystemSettings()" disabled style="opacity: 0.5;">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                                    <polyline points="17 21 17 13 7 13 7 21"/>
                                    <polyline points="7 3 7 8 15 8"/>
                                </svg>
                                Save System Settings
                            </button>
                            <span id="systemConfigStatus" style="margin-left: 12px; font-size: 12px; color: var(--text-tertiary);"></span>
                        </div>
                    </div>

                    <div class="settings-divider"></div>

                    <!-- API Keys Management (shown when API keys enabled) -->
                    <div class="admin-section" id="apiKeysSection" style="display: none;">
                        <div class="admin-section-header">
                            <h3 class="admin-section-title">API Keys</h3>
                            <button class="settings-btn" onclick="openCreateAPIKeyModal()" style="padding: 6px 12px; font-size: 12px;">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M12 5v14M5 12h14"/>
                                </svg>
                                Create Key
                            </button>
                        </div>
                        <p class="settings-desc" style="margin-bottom: 12px;">Manage API keys for programmatic access</p>
                        <div class="admin-list" id="apiKeysList">
                            <div class="admin-loading">Loading API keys...</div>
                        </div>
                    </div>

                    </div><!-- End Auth Sub-Panel -->

                    <!-- Discovery Sub-Panel -->
                    <div class="admin-subpanel" data-admin-panel="discovery">

                    <!-- Docker Discovery -->
                    <div class="admin-section" id="dockerDiscoverySection">
                        <div class="admin-section-header">
                            <h3 class="admin-section-title">Docker Discovery</h3>
                            <button class="settings-btn" onclick="refreshDockerDiscovery()" id="dockerRefreshBtn" style="padding: 6px 12px; font-size: 12px; display: none;">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M23 4v6h-6"/>
                                    <path d="M1 20v-6h6"/>
                                    <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                                </svg>
                                Refresh
                            </button>
                        </div>
                        <p class="settings-desc" style="margin-bottom: 12px;">Automatically discover services from Docker containers with dashgate.* labels</p>

                        <div class="settings-row">
                            <div class="settings-label">
                                <span>Enable Docker Discovery</span>
                                <span class="settings-hint" id="dockerStatusHint">Not configured</span>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="dockerDiscoveryEnabled" onchange="markDiscoveryDirty(); toggleDockerSection()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <!-- Docker Config Section -->
                        <div id="dockerConfigSection" class="auth-config-section" style="display: none;">
                            <div class="auth-config-inner">
                                <div class="admin-form-group">
                                    <label for="dockerSocketPath">Docker Socket Path</label>
                                    <input type="text" id="dockerSocketPath" class="admin-input" placeholder="/var/run/docker.sock" onchange="markDiscoveryDirty()">
                                    <p class="settings-desc" style="margin-top: 4px;">Path to Docker socket (usually /var/run/docker.sock)</p>
                                </div>
                                <div id="dockerEnvOverride" class="env-override-notice" style="display: none;">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                                    </svg>
                                    <span>Controlled by DOCKER_DISCOVERY environment variable. UI changes won't take effect until the env var is removed.</span>
                                </div>
                            </div>
                        </div>

                        <!-- Docker Help Section -->
                        <div id="dockerDiscoveryHelp" style="margin-top: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                            <p style="font-size: 13px; margin-bottom: 8px; font-weight: 500;">Setup Instructions</p>

                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;"><strong>Option 1: Configure via UI (recommended)</strong></p>
                            <ol style="font-size: 12px; color: var(--text-secondary); margin-left: 16px; line-height: 1.8; margin-bottom: 12px;">
                                <li>Mount the Docker socket to your container (see docker-compose example below)</li>
                                <li>Enable the toggle above</li>
                                <li>Click "Save Discovery Settings"</li>
                            </ol>

                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;"><strong>Option 2: Configure via Environment</strong></p>
                            <ul style="font-size: 12px; color: var(--text-secondary); margin-left: 16px; line-height: 1.8; margin-bottom: 12px;">
                                <li><code>DOCKER_DISCOVERY=true</code></li>
                                <li><code>DOCKER_SOCKET=/var/run/docker.sock</code> (optional)</li>
                            </ul>

                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;"><strong>docker-compose.yml example:</strong></p>
                            <pre style="font-size: 11px; background: var(--bg-secondary); padding: 8px; border-radius: 4px; overflow-x: auto; margin-bottom: 12px;">volumes:
  - /var/run/docker.sock:/var/run/docker.sock:ro</pre>

                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;"><strong>Container Labels:</strong></p>
                            <pre style="font-size: 11px; background: var(--bg-secondary); padding: 8px; border-radius: 4px; overflow-x: auto;">labels:
  - "dashgate.enable=true"
  - "dashgate.name=My App"
  - "dashgate.url=http://myapp:8080"
  - "dashgate.icon=app.svg"        # optional
  - "dashgate.groups=users,admins" # optional</pre>
                        </div>
                    </div>

                    <div class="settings-divider"></div>

                    <!-- Traefik Discovery -->
                    <div class="admin-section" id="traefikDiscoverySection">
                        <div class="admin-section-header">
                            <h3 class="admin-section-title">Traefik Discovery</h3>
                            <button class="settings-btn" onclick="refreshTraefikDiscovery()" id="traefikRefreshBtn" style="padding: 6px 12px; font-size: 12px; display: none;">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M23 4v6h-6"/>
                                    <path d="M1 20v-6h6"/>
                                    <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                                </svg>
                                Refresh
                            </button>
                        </div>
                        <p class="settings-desc" style="margin-bottom: 12px;">Automatically discover services from Traefik reverse proxy</p>

                        <div class="settings-row">
                            <div class="settings-label">
                                <span>Enable Traefik Discovery</span>
                                <span class="settings-hint" id="traefikStatusHint">Not configured</span>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="traefikDiscoveryEnabled" onchange="markDiscoveryDirty(); toggleTraefikSection()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <!-- Traefik Config Section -->
                        <div id="traefikConfigSection" class="auth-config-section" style="display: none;">
                            <div class="auth-config-inner">
                                <div class="admin-form-group">
                                    <label for="traefikUrl">Traefik API URL *</label>
                                    <input type="url" id="traefikUrl" class="admin-input" placeholder="http://traefik:8080" onchange="markDiscoveryDirty()">
                                </div>
                                <p class="settings-desc" style="margin: 12px 0 8px 0; font-weight: 500;">Authentication (optional)</p>
                                <p class="settings-desc" style="margin-bottom: 8px;">If your Traefik API is protected with basic auth, enter credentials below.</p>
                                <div class="admin-form-row">
                                    <div class="admin-form-group" style="flex: 1;">
                                        <label for="traefikUsername">Username</label>
                                        <input type="text" id="traefikUsername" class="admin-input" placeholder="admin" onchange="markDiscoveryDirty()">
                                    </div>
                                    <div class="admin-form-group" style="flex: 1;">
                                        <label for="traefikPassword">Password</label>
                                        <input type="password" id="traefikPassword" class="admin-input" placeholder="Leave blank to keep current" onchange="markDiscoveryDirty()">
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                                    <button class="settings-btn" onclick="testTraefikConnection()">Test Connection</button>
                                    <span id="traefikTestResult" style="font-size: 12px;"></span>
                                </div>
                                <div id="traefikEnvOverride" class="env-override-notice" style="display: none; margin-top: 8px;">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                                    </svg>
                                    <span>Controlled by TRAEFIK_DISCOVERY environment variable. UI changes won't take effect until the env var is removed.</span>
                                </div>
                            </div>
                        </div>

                        <!-- Traefik Help Section -->
                        <div id="traefikDiscoveryHelp" style="margin-top: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                            <p style="font-size: 13px; margin-bottom: 8px; font-weight: 500;">Setup Instructions</p>

                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;"><strong>Option 1: Configure via UI (recommended)</strong></p>
                            <ol style="font-size: 12px; color: var(--text-secondary); margin-left: 16px; line-height: 1.8; margin-bottom: 12px;">
                                <li>Enter your Traefik API URL above</li>
                                <li>Click "Test Connection" to verify access</li>
                                <li>Enable the toggle and click "Save Discovery Settings"</li>
                            </ol>

                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;"><strong>Option 2: Configure via Environment</strong></p>
                            <ul style="font-size: 12px; color: var(--text-secondary); margin-left: 16px; line-height: 1.8; margin-bottom: 12px;">
                                <li><code>TRAEFIK_URL=http://traefik:8080</code></li>
                                <li><code>TRAEFIK_DISCOVERY=true</code></li>
                            </ul>

                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;"><strong>docker-compose.yml example:</strong></p>
                            <pre style="font-size: 11px; background: var(--bg-secondary); padding: 8px; border-radius: 4px; overflow-x: auto;">environment:
  - TRAEFIK_URL=http://traefik:8080
  - TRAEFIK_DISCOVERY=true</pre>
                        </div>
                    </div>

                    <div class="settings-divider"></div>

                    <!-- Nginx Config Discovery -->
                    <div class="admin-section" id="nginxDiscoverySection">
                        <div class="admin-section-header">
                            <h3 class="admin-section-title">Nginx Config Discovery</h3>
                            <button class="settings-btn" onclick="refreshNginxDiscovery()" id="nginxRefreshBtn" style="padding: 6px 12px; font-size: 12px; display: none;">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M23 4v6h-6"/>
                                    <path d="M1 20v-6h6"/>
                                    <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                                </svg>
                                Refresh
                            </button>
                        </div>
                        <p class="settings-desc" style="margin-bottom: 12px;">Automatically discover services from Nginx configuration files</p>

                        <div class="settings-row">
                            <div class="settings-label">
                                <span>Enable Nginx Discovery</span>
                                <span class="settings-hint" id="nginxStatusHint">Not configured</span>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="nginxDiscoveryEnabled" onchange="markDiscoveryDirty(); toggleNginxSection()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <!-- Nginx Config Section -->
                        <div id="nginxConfigSection" class="auth-config-section" style="display: none;">
                            <div class="auth-config-inner">
                                <div class="admin-form-group">
                                    <label for="nginxConfigPath">Nginx Config Path</label>
                                    <input type="text" id="nginxConfigPath" class="admin-input" placeholder="/etc/nginx/conf.d" onchange="markDiscoveryDirty()">
                                    <p class="settings-desc" style="margin-top: 4px;">Directory containing nginx .conf files</p>
                                </div>
                                <div id="nginxEnvOverride" class="env-override-notice" style="display: none;">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                                    </svg>
                                    <span>Controlled by NGINX_DISCOVERY environment variable. UI changes won't take effect until the env var is removed.</span>
                                </div>
                            </div>
                        </div>

                        <!-- Nginx Help Section -->
                        <div id="nginxDiscoveryHelp" style="margin-top: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                            <p style="font-size: 13px; margin-bottom: 8px; font-weight: 500;">Setup Instructions</p>

                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;"><strong>Option 1: Configure via UI (recommended)</strong></p>
                            <ol style="font-size: 12px; color: var(--text-secondary); margin-left: 16px; line-height: 1.8; margin-bottom: 12px;">
                                <li>Mount your nginx config directory to the container</li>
                                <li>Enter the path above</li>
                                <li>Enable the toggle and click "Save Discovery Settings"</li>
                            </ol>

                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;"><strong>Option 2: Configure via Environment</strong></p>
                            <ul style="font-size: 12px; color: var(--text-secondary); margin-left: 16px; line-height: 1.8; margin-bottom: 12px;">
                                <li><code>NGINX_DISCOVERY=true</code></li>
                                <li><code>NGINX_CONFIG_PATH=/etc/nginx/conf.d</code> (optional)</li>
                            </ul>

                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;"><strong>docker-compose.yml example:</strong></p>
                            <pre style="font-size: 11px; background: var(--bg-secondary); padding: 8px; border-radius: 4px; overflow-x: auto;">volumes:
  - /etc/nginx/conf.d:/etc/nginx/conf.d:ro
environment:
  - NGINX_DISCOVERY=true</pre>

                            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">Services with <code>server_name</code> and <code>proxy_pass</code> directives will be discovered.</p>
                        </div>
                    </div>

                    <div class="settings-divider"></div>

                    <!-- NPM Discovery -->
                    <div class="admin-section" id="npmDiscoverySection">
                        <div class="admin-section-header">
                            <h3 class="admin-section-title">Nginx Proxy Manager Discovery</h3>
                            <button class="settings-btn" onclick="refreshNPMDiscovery()" id="npmRefreshBtn" style="padding: 6px 12px; font-size: 12px; display: none;">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M23 4v6h-6"/>
                                    <path d="M1 20v-6h6"/>
                                    <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                                </svg>
                                Refresh
                            </button>
                        </div>
                        <p class="settings-desc" style="margin-bottom: 12px;">Automatically discover services from Nginx Proxy Manager API</p>

                        <div class="settings-row">
                            <div class="settings-label">
                                <span>Enable NPM Discovery</span>
                                <span class="settings-hint" id="npmStatusHint">Not configured</span>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="npmDiscoveryEnabled" onchange="markDiscoveryDirty(); toggleNPMSection()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <!-- NPM Config Section -->
                        <div id="npmConfigSection" class="auth-config-section" style="display: none;">
                            <div class="auth-config-inner">
                                <div class="admin-form-group">
                                    <label for="npmUrl">NPM API URL *</label>
                                    <input type="url" id="npmUrl" class="admin-input" placeholder="http://npm:81" onchange="markDiscoveryDirty()">
                                </div>
                                <div class="admin-form-row">
                                    <div class="admin-form-group" style="flex: 1;">
                                        <label for="npmEmail">Admin Email *</label>
                                        <input type="email" id="npmEmail" class="admin-input" placeholder="admin@example.com" onchange="markDiscoveryDirty()">
                                    </div>
                                    <div class="admin-form-group" style="flex: 1;">
                                        <label for="npmPassword">Admin Password *</label>
                                        <input type="password" id="npmPassword" class="admin-input" placeholder="Leave blank to keep current" onchange="markDiscoveryDirty()">
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                                    <button class="settings-btn" onclick="testNPMConnection()">Test Connection</button>
                                    <span id="npmTestResult" style="font-size: 12px;"></span>
                                </div>
                                <div id="npmEnvOverride" class="env-override-notice" style="display: none; margin-top: 8px;">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                                    </svg>
                                    <span>Controlled by NPM_DISCOVERY environment variable. UI changes won't take effect until the env var is removed.</span>
                                </div>
                            </div>
                        </div>

                        <!-- NPM Help Section -->
                        <div id="npmDiscoveryHelp" style="margin-top: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                            <p style="font-size: 13px; margin-bottom: 8px; font-weight: 500;">Setup Instructions</p>

                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;"><strong>Option 1: Configure via UI (recommended)</strong></p>
                            <ol style="font-size: 12px; color: var(--text-secondary); margin-left: 16px; line-height: 1.8; margin-bottom: 12px;">
                                <li>Enter your NPM API URL and admin credentials above</li>
                                <li>Click "Test Connection" to verify access</li>
                                <li>Enable the toggle and click "Save Discovery Settings"</li>
                            </ol>

                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;"><strong>Option 2: Configure via Environment</strong></p>
                            <ul style="font-size: 12px; color: var(--text-secondary); margin-left: 16px; line-height: 1.8; margin-bottom: 12px;">
                                <li><code>NPM_URL=http://npm:81</code></li>
                                <li><code>NPM_EMAIL=admin@example.com</code></li>
                                <li><code>NPM_PASSWORD=changeme</code></li>
                                <li><code>NPM_DISCOVERY=true</code></li>
                            </ul>

                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;"><strong>docker-compose.yml example:</strong></p>
                            <pre style="font-size: 11px; background: var(--bg-secondary); padding: 8px; border-radius: 4px; overflow-x: auto;">environment:
  - NPM_URL=http://npm:81
  - NPM_EMAIL=admin@example.com
  - NPM_PASSWORD=changeme
  - NPM_DISCOVERY=true</pre>
                        </div>
                    </div>

                    <div class="settings-divider"></div>

                    <!-- Caddy Discovery -->
                    <div class="admin-section" id="caddyDiscoverySection">
                        <div class="admin-section-header">
                            <h3 class="admin-section-title">Caddy Discovery</h3>
                            <button class="settings-btn" onclick="refreshCaddyDiscovery()" id="caddyRefreshBtn" style="padding: 6px 12px; font-size: 12px; display: none;">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M23 4v6h-6"/>
                                    <path d="M1 20v-6h6"/>
                                    <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                                </svg>
                                Refresh
                            </button>
                        </div>
                        <p class="settings-desc" style="margin-bottom: 12px;">Automatically discover services from Caddy reverse proxy</p>

                        <div class="settings-row">
                            <div class="settings-label">
                                <span>Enable Caddy Discovery</span>
                                <span class="settings-hint" id="caddyStatusHint">Not configured</span>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="caddyDiscoveryEnabled" onchange="markDiscoveryDirty(); toggleCaddySection()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <!-- Caddy Config Section -->
                        <div id="caddyConfigSection" class="auth-config-section" style="display: none;">
                            <div class="auth-config-inner">
                                <div class="admin-form-group">
                                    <label for="caddyAdminUrl">Caddy Admin API URL *</label>
                                    <input type="url" id="caddyAdminUrl" class="admin-input" placeholder="http://caddy:2019" onchange="markDiscoveryDirty()">
                                </div>
                                <p class="settings-desc" style="margin: 12px 0 8px 0; font-weight: 500;">Authentication (optional)</p>
                                <p class="settings-desc" style="margin-bottom: 8px;">If your Caddy Admin API is behind a reverse proxy with basic auth, enter credentials below.</p>
                                <div class="admin-form-row">
                                    <div class="admin-form-group" style="flex: 1;">
                                        <label for="caddyUsername">Username</label>
                                        <input type="text" id="caddyUsername" class="admin-input" placeholder="admin" onchange="markDiscoveryDirty()">
                                    </div>
                                    <div class="admin-form-group" style="flex: 1;">
                                        <label for="caddyPassword">Password</label>
                                        <input type="password" id="caddyPassword" class="admin-input" placeholder="Leave blank to keep current" onchange="markDiscoveryDirty()">
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                                    <button class="settings-btn" onclick="testCaddyConnection()">Test Connection</button>
                                    <span id="caddyTestResult" style="font-size: 12px;"></span>
                                </div>
                                <div id="caddyEnvOverride" class="env-override-notice" style="display: none; margin-top: 8px;">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                                    </svg>
                                    <span>Controlled by CADDY_DISCOVERY environment variable. UI changes won't take effect until the env var is removed.</span>
                                </div>
                            </div>
                        </div>

                        <!-- Caddy Help Section -->
                        <div id="caddyDiscoveryHelp" style="margin-top: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                            <p style="font-size: 13px; margin-bottom: 8px; font-weight: 500;">Setup Instructions</p>

                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;"><strong>Option 1: Configure via UI (recommended)</strong></p>
                            <ol style="font-size: 12px; color: var(--text-secondary); margin-left: 16px; line-height: 1.8; margin-bottom: 12px;">
                                <li>Enter your Caddy Admin API URL above (default port is 2019)</li>
                                <li>Click "Test Connection" to verify access</li>
                                <li>Enable the toggle and click "Save Discovery Settings"</li>
                            </ol>

                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;"><strong>Option 2: Configure via Environment</strong></p>
                            <ul style="font-size: 12px; color: var(--text-secondary); margin-left: 16px; line-height: 1.8; margin-bottom: 12px;">
                                <li><code>CADDY_ADMIN_URL=http://caddy:2019</code></li>
                                <li><code>CADDY_DISCOVERY=true</code></li>
                            </ul>

                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;"><strong>docker-compose.yml example:</strong></p>
                            <pre style="font-size: 11px; background: var(--bg-secondary); padding: 8px; border-radius: 4px; overflow-x: auto;">environment:
  - CADDY_ADMIN_URL=http://caddy:2019
  - CADDY_DISCOVERY=true</pre>

                            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">Routes with <code>reverse_proxy</code> handlers will be discovered.</p>
                        </div>
                    </div>

                    <div class="settings-divider"></div>

                    <!-- Save Button -->
                    <div style="display: flex; justify-content: flex-end; padding: 8px 0;">
                        <button class="settings-btn admin-btn-primary" id="saveDiscoveryConfig" onclick="saveDiscoverySettings()" disabled>
                            Save Discovery Settings
                        </button>
                    </div>

                    </div><!-- End Discovery Sub-Panel -->

                    <!-- Content Sub-Panel -->
                    <div class="admin-subpanel active" data-admin-panel="content">

                    <!-- Backup/Restore -->
                    <div class="admin-section">
                        <div class="admin-section-header">
                            <h3 class="admin-section-title">Backup & Restore</h3>
                        </div>
                        <p class="settings-desc" style="margin-bottom: 16px;">Export or import your DashGate configuration</p>

                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="settings-btn" onclick="downloadBackup()" style="display: flex; align-items: center; gap: 6px;">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                                    <polyline points="7 10 12 15 17 10"/>
                                    <line x1="12" y1="15" x2="12" y2="3"/>
                                </svg>
                                Download Backup
                            </button>
                            <label class="settings-btn" style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                                    <polyline points="17 8 12 3 7 8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                                Restore from Backup
                                <input type="file" accept=".json" onchange="restoreFromBackup(this)" style="display: none;">
                            </label>
                        </div>
                        <p class="settings-desc" style="margin-top: 12px; font-size: 11px; color: var(--orange);">
                            Note: Passwords and secrets are not included in backups for security reasons.
                        </p>
                    </div>

                    <div class="settings-divider"></div>

                    <!-- App Management -->
                    <div class="admin-section">
                        <div class="admin-section-header">
                            <h3 class="admin-section-title">Manage Apps</h3>
                            <button class="settings-btn" onclick="openCreateAppModal()" style="padding: 6px 12px; font-size: 12px;">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M12 5v14M5 12h14"/>
                                </svg>
                                Add App
                            </button>
                        </div>
                        <p class="settings-desc" style="margin-bottom: 12px;">Apps on DashGate, both manually added and configured from discovery.</p>
                        <div class="admin-search">
                            <input type="text" id="appSearchInput" placeholder="Search apps..." class="admin-search-input" oninput="filterApps()">
                        </div>
                        <div class="admin-list" id="appsList">
                            <div class="admin-loading">Loading apps...</div>
                        </div>
                    </div>

                    <div class="settings-divider"></div>

                    <!-- Category Management -->
                    <div class="admin-section">
                        <div class="admin-section-header">
                            <h3 class="admin-section-title">Categories</h3>
                            <button class="settings-btn" onclick="openCreateCategoryModal()" style="padding: 6px 12px; font-size: 12px;">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M12 5v14M5 12h14"/>
                                </svg>
                                Add
                            </button>
                        </div>
                        <div class="admin-list admin-list-compact" id="categoriesList">
                            <div class="admin-loading">Loading categories...</div>
                        </div>
                    </div>

                    <div class="settings-divider"></div>

                    <!-- Discovered Apps Management -->
                    <div class="admin-section">
                        <div class="admin-section-header">
                            <h3 class="admin-section-title">Discovered Apps <span class="discovered-count-badge" id="discoveredCountBadge" style="display:none;">0</span></h3>
                        </div>
                        <p class="settings-desc" style="margin-bottom: 12px;">Unconfigured apps found by discovery engines. Configure them to add to DashGate.</p>
                        <div class="admin-search" style="margin-bottom: 8px;">
                            <input type="text" id="discoveredSearchInput" placeholder="Search discovered apps..." class="admin-search-input" oninput="filterDiscoveredApps()">
                        </div>
                        <div class="discovered-source-filters" id="discoveredSourceFilters">
                            <button class="discovered-source-filter active" onclick="filterDiscoveredBySource('all')">All</button>
                            <button class="discovered-source-filter" onclick="filterDiscoveredBySource('docker')">Docker</button>
                            <button class="discovered-source-filter" onclick="filterDiscoveredBySource('traefik')">Traefik</button>
                            <button class="discovered-source-filter" onclick="filterDiscoveredBySource('nginx')">Nginx</button>
                            <button class="discovered-source-filter" onclick="filterDiscoveredBySource('npm')">NPM</button>
                            <button class="discovered-source-filter" onclick="filterDiscoveredBySource('caddy')">Caddy</button>
                        </div>
                        <div class="discovered-apps-list" id="discoveredAppsList">
                            <div class="admin-loading">Loading discovered apps...</div>
                        </div>
                        <div id="discoveredStaleSection" style="display:none;"></div>
                    </div>

                    </div><!-- End Content Sub-Panel -->

                    <!-- Users Sub-Panel -->
                    <div class="admin-subpanel" data-admin-panel="users">

                    <!-- Local Users (shown when local auth is enabled) -->
                    <div class="admin-section" id="localUsersSection" style="display: none;">
                        <div class="admin-section-header">
                            <h3 class="admin-section-title">Local Users</h3>
                            <button class="settings-btn" onclick="openCreateLocalUserModal()" style="padding: 6px 12px; font-size: 12px;">
                                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M12 5v14M5 12h14"/>
                                </svg>
                                Add User
                            </button>
                        </div>
                        <p class="settings-desc" style="margin-bottom: 12px;">Manage local user accounts for DashGate access</p>
                        <div class="admin-search">
                            <input type="text" id="localUserSearchInput" placeholder="Search local users..." class="admin-search-input" oninput="filterLocalUsers()">
                        </div>
                        <div class="admin-list" id="localUsersList">
                            <div class="admin-loading">Loading local users...</div>
                        </div>
                    </div>

                    <div class="settings-divider" id="localUsersDivider" style="display: none;"></div>

                    <!-- Local Groups -->
                    <div class="admin-section" id="localGroupsSection" style="display: none;">
                        <div class="admin-section-header">
                            <h3 class="admin-section-title">Groups</h3>
                            <div style="display:flex;gap:6px;align-items:center;">
                                <input type="text" id="newLocalGroupInput" placeholder="New group name..." class="admin-search-input" style="width:160px;padding:6px 10px;font-size:12px;" onkeydown="if(event.key==='Enter')addLocalGroup()">
                                <button class="settings-btn" onclick="addLocalGroup()" style="padding:6px 12px;font-size:12px;">
                                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path d="M12 5v14M5 12h14"/>
                                    </svg>
                                    Add
                                </button>
                            </div>
                        </div>
                        <p class="settings-desc" style="margin-bottom: 12px;">Groups control which apps users can access. Assign groups to users and apps.</p>
                        <div class="admin-list admin-list-compact" id="localGroupsList">
                        </div>
                    </div>

                    <div class="settings-divider" id="lldapDivider" style="display: none;"></div>

                    <!-- Read-only Users (LLDAP) -->
                    <div class="admin-section" id="lldapUsersSection" style="display: none;">
                        <div class="admin-section-header">
                            <h3 class="admin-section-title">LLDAP Users</h3>
                            <span class="admin-readonly-badge">Read-only</span>
                        </div>
                        <div class="admin-search">
                            <input type="text" id="userSearchInput" placeholder="Search users..." class="admin-search-input" oninput="filterUsers()">
                        </div>
                        <div class="admin-list admin-list-compact" id="usersList">
                            <div class="admin-loading">Loading users...</div>
                        </div>
                    </div>

                    <div class="settings-divider" id="lldapGroupsDivider" style="display: none;"></div>

                    <!-- Read-only Groups (LLDAP) -->
                    <div class="admin-section" id="lldapGroupsSection" style="display: none;">
                        <div class="admin-section-header">
                            <h3 class="admin-section-title">LLDAP Groups</h3>
                            <span class="admin-readonly-badge">Read-only</span>
                        </div>
                        <div class="admin-list admin-list-compact" id="groupsList">
                            <div class="admin-loading">Loading groups...</div>
                        </div>
                    </div>

                    </div><!-- End Users Sub-Panel -->

                </div>
            </div>
        </div>
    </div>

    <!-- Edit App Access Modal -->
    <div class="admin-modal" id="editAppModal" role="dialog" aria-modal="true" aria-label="Admin">
        <div class="admin-modal-backdrop" onclick="closeEditAppModal()"></div>
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h3 id="editAppTitle">Edit App Access</h3>
                <button class="settings-close" onclick="closeEditAppModal()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="admin-modal-body">
                <input type="hidden" id="editAppUrl">
                <p class="settings-desc" style="margin-bottom: 16px;">Select which groups can access this app:</p>
                <div class="admin-group-checkboxes" id="appGroupCheckboxes">
                    <!-- Checkboxes populated by JS -->
                </div>
            </div>
            <div class="admin-modal-footer">
                <button class="settings-btn" onclick="closeEditAppModal()">Cancel</button>
                <button class="settings-btn admin-btn-primary" onclick="saveAppAccess()">Save</button>
            </div>
        </div>
    </div>

    <!-- Create/Edit App Modal -->
    <div class="admin-modal" id="appConfigModal" role="dialog" aria-modal="true" aria-label="Admin">
        <div class="admin-modal-backdrop" onclick="closeAppConfigModal()"></div>
        <div class="admin-modal-content" style="max-width: 500px; max-height: 90vh;">
            <div class="admin-modal-header">
                <h3 id="appConfigTitle">Add App</h3>
                <button class="settings-close" onclick="closeAppConfigModal()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="admin-modal-body" style="max-height: 60vh; overflow-y: auto;">
                <input type="hidden" id="appConfigOriginalUrl">

                <div class="admin-form-group">
                    <label for="appConfigName">Name *</label>
                    <input type="text" id="appConfigName" class="admin-input" placeholder="My App">
                </div>

                <div class="admin-form-group">
                    <label for="appConfigUrl">URL *</label>
                    <input type="url" id="appConfigUrl" class="admin-input" placeholder="https://example.com">
                </div>

                <div class="admin-form-group">
                    <label for="appConfigCategory">Category *</label>
                    <select id="appConfigCategory" class="admin-input">
                        <!-- Populated by JS -->
                    </select>
                </div>

                <div class="admin-form-group">
                    <label for="appConfigDesc">Description</label>
                    <input type="text" id="appConfigDesc" class="admin-input" placeholder="Optional description">
                </div>

                <div class="admin-form-group">
                    <label>Icon</label>
                    <div class="icon-selector">
                        <div class="icon-preview" id="iconPreview">
                            <span style="color: var(--text-tertiary)">No icon</span>
                        </div>
                        <div class="icon-actions">
                            <button class="settings-btn" onclick="openIconSelector()" style="flex: 1;">Choose Icon</button>
                            <label class="settings-btn" style="flex: 1; text-align: center; cursor: pointer;">
                                Upload
                                <input type="file" id="iconUploadInput" accept=".svg,.png,.jpg,.jpeg,.webp,.ico" style="display: none;" onchange="uploadIcon(event)">
                            </label>
                        </div>
                        <input type="hidden" id="appConfigIcon">
                    </div>
                </div>

                <div class="admin-form-group">
                    <label>Access Groups</label>
                    <p class="settings-desc" style="margin-bottom: 8px;">Select which groups can see this app</p>
                    <div class="admin-group-checkboxes" id="appConfigGroups" style="max-height: 150px;">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
            <div class="admin-modal-footer">
                <button class="settings-btn" onclick="closeAppConfigModal()">Cancel</button>
                <button class="settings-btn admin-btn-primary" onclick="saveAppConfig()">Save</button>
            </div>
        </div>
    </div>

    <!-- Icon Selector Modal -->
    <div class="admin-modal" id="iconSelectorModal" role="dialog" aria-modal="true" aria-label="Admin">
        <div class="admin-modal-backdrop" onclick="closeIconSelector()"></div>
        <div class="admin-modal-content" style="max-width: 450px;">
            <div class="admin-modal-header">
                <h3>Select Icon</h3>
                <button class="settings-close" onclick="closeIconSelector()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="admin-modal-body">
                <div class="admin-search" style="margin-bottom: 12px;">
                    <input type="text" id="iconSearchInput" placeholder="Search icons..." class="admin-search-input" oninput="filterIcons()">
                </div>
                <div class="icon-grid" id="iconGrid">
                    <div class="admin-loading">Loading icons...</div>
                </div>
            </div>
            <div class="admin-modal-footer">
                <button class="settings-btn" onclick="selectIcon('')">No Icon</button>
                <button class="settings-btn" onclick="closeIconSelector()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div class="admin-modal" id="categoryModal" role="dialog" aria-modal="true" aria-label="Admin">
        <div class="admin-modal-backdrop" onclick="closeCategoryModal()"></div>
        <div class="admin-modal-content" style="max-width: 350px;">
            <div class="admin-modal-header">
                <h3 id="categoryModalTitle">Add Category</h3>
                <button class="settings-close" onclick="closeCategoryModal()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="admin-modal-body">
                <input type="hidden" id="categoryOldName">
                <div class="admin-form-group">
                    <label for="categoryNameInput">Category Name *</label>
                    <input type="text" id="categoryNameInput" class="admin-input" placeholder="Category name">
                </div>
            </div>
            <div class="admin-modal-footer">
                <button class="settings-btn" onclick="closeCategoryModal()">Cancel</button>
                <button class="settings-btn admin-btn-primary" onclick="saveCategory()">Save</button>
            </div>
        </div>
    </div>

    <!-- Discovered App Configure Modal -->
    <div class="admin-modal" id="discoveredAppModal" role="dialog" aria-modal="true" aria-label="Admin">
        <div class="admin-modal-backdrop" onclick="closeDiscoveredAppModal()"></div>
        <div class="admin-modal-content" style="max-width: 500px; max-height: 90vh;">
            <div class="admin-modal-header">
                <h3>Configure Discovered App</h3>
                <button class="settings-close" onclick="closeDiscoveredAppModal()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="admin-modal-body" style="max-height: 60vh; overflow-y: auto;">
                <input type="hidden" id="discoveredAppUrl">
                <input type="hidden" id="discoveredAppSource">

                <!-- Discovery info (read-only) -->
                <div class="discovered-info-box">
                    <div class="discovered-info-row">
                        <span class="discovered-info-label">Name</span>
                        <span class="discovered-info-value" id="discoveredAppOrigName"></span>
                    </div>
                    <div class="discovered-info-row">
                        <span class="discovered-info-label">URL</span>
                        <span class="discovered-info-value" id="discoveredAppOrigUrl"></span>
                    </div>
                    <div class="discovered-info-row">
                        <span class="discovered-info-label">Source</span>
                        <span class="discovered-info-value" id="discoveredAppOrigSource"></span>
                    </div>
                </div>

                <!-- Hidden toggle -->
                <div class="admin-form-group">
                    <label class="admin-group-checkbox" style="margin-bottom: 4px;">
                        <input type="checkbox" id="discoveredAppHidden" onchange="toggleDiscoveredConfigFields()">
                        <span class="admin-group-checkbox-label">Hidden (never show on DashGate)</span>
                    </label>
                </div>

                <div id="discoveredConfigFields">
                    <!-- Display Name Override -->
                    <div class="admin-form-group">
                        <label for="discoveredAppNameOverride">Display Name Override</label>
                        <input type="text" id="discoveredAppNameOverride" class="admin-input" placeholder="Leave empty to use discovered name">
                    </div>

                    <!-- URL Override -->
                    <div class="admin-form-group">
                        <label for="discoveredAppUrlOverride">URL (external/public) *</label>
                        <input type="url" id="discoveredAppUrlOverride" class="admin-input" placeholder="https://app.example.com">
                        <p class="settings-desc" style="margin-top: 4px; font-size: 11px;">The URL users will navigate to. Discovered internal URL is shown above for reference.</p>
                    </div>

                    <!-- Category -->
                    <div class="admin-form-group">
                        <label for="discoveredAppCategory">Category *</label>
                        <select id="discoveredAppCategory" class="admin-input">
                            <!-- Populated by JS -->
                        </select>
                    </div>

                    <!-- Description Override -->
                    <div class="admin-form-group">
                        <label for="discoveredAppDescOverride">Description Override</label>
                        <input type="text" id="discoveredAppDescOverride" class="admin-input" placeholder="Leave empty to use discovered description">
                    </div>

                    <!-- Icon Override -->
                    <div class="admin-form-group">
                        <label>Icon Override</label>
                        <div class="icon-selector">
                            <div class="icon-preview" id="discoveredIconPreview">
                                <span style="color: var(--text-tertiary)">No icon override</span>
                            </div>
                            <div class="icon-actions">
                                <button class="settings-btn" onclick="openDiscoveredIconSelector()" style="flex: 1;">Choose Icon</button>
                                <button class="settings-btn" onclick="clearDiscoveredIcon()" style="flex: 1;">Clear</button>
                            </div>
                            <input type="hidden" id="discoveredAppIconOverride">
                        </div>
                    </div>

                    <!-- Access Groups -->
                    <div class="admin-form-group">
                        <label>Access Groups *</label>
                        <p class="settings-desc" style="margin-bottom: 8px;">Select which groups can see this app</p>
                        <div class="admin-group-checkboxes" id="discoveredAppGroups" style="max-height: 150px;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="admin-modal-footer">
                <button class="settings-btn" onclick="closeDiscoveredAppModal()">Cancel</button>
                <button class="settings-btn admin-btn-primary" onclick="saveDiscoveredAppConfig()">Save</button>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="admin-modal" id="confirmDeleteModal" role="alertdialog" aria-modal="true" aria-label="Confirm deletion">
        <div class="admin-modal-backdrop" onclick="closeConfirmDelete()"></div>
        <div class="admin-modal-content" style="max-width: 350px;">
            <div class="admin-modal-header">
                <h3>Confirm Delete</h3>
                <button class="settings-close" onclick="closeConfirmDelete()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="admin-modal-body">
                <p id="confirmDeleteMessage">Are you sure you want to delete this item?</p>
            </div>
            <div class="admin-modal-footer">
                <button class="settings-btn" onclick="closeConfirmDelete()">Cancel</button>
                <button class="settings-btn" style="background: var(--red); color: white;" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- My App Modal -->
    <div class="admin-modal" id="myAppModal" role="dialog" aria-modal="true" aria-label="Admin">
        <div class="admin-modal-backdrop" onclick="closeMyAppModal()"></div>
        <div class="admin-modal-content" style="max-width: 400px;">
            <div class="admin-modal-header">
                <h3 id="myAppModalTitle">Add Personal App</h3>
                <button class="settings-close" onclick="closeMyAppModal()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="admin-modal-body">
                <input type="hidden" id="myAppEditIndex">

                <div class="admin-form-group">
                    <label for="myAppName">Name *</label>
                    <input type="text" id="myAppName" class="admin-input" placeholder="My Website">
                </div>

                <div class="admin-form-group">
                    <label for="myAppUrl">URL *</label>
                    <input type="url" id="myAppUrl" class="admin-input" placeholder="https://example.com">
                </div>

                <div class="admin-form-group">
                    <label for="myAppDesc">Description</label>
                    <input type="text" id="myAppDesc" class="admin-input" placeholder="Optional description">
                </div>

                <div class="admin-form-group">
                    <label for="myAppIcon">Icon URL (optional)</label>
                    <input type="url" id="myAppIcon" class="admin-input" placeholder="https://example.com/favicon.ico">
                    <p class="settings-desc" style="margin-top: 4px;">Leave empty to use first letter of name</p>
                </div>
            </div>
            <div class="admin-modal-footer">
                <button class="settings-btn" onclick="closeMyAppModal()">Cancel</button>
                <button class="settings-btn admin-btn-primary" onclick="saveMyApp()">Save</button>
            </div>
        </div>
    </div>

    <!-- Local User Modal -->
    <div class="admin-modal" id="localUserModal" role="dialog" aria-modal="true" aria-label="Admin">
        <div class="admin-modal-backdrop" onclick="closeLocalUserModal()"></div>
        <div class="admin-modal-content" style="max-width: 450px;">
            <div class="admin-modal-header">
                <h3 id="localUserModalTitle">Add Local User</h3>
                <button class="settings-close" onclick="closeLocalUserModal()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="admin-modal-body" style="max-height: 60vh; overflow-y: auto;">
                <input type="hidden" id="localUserEditId">

                <div class="admin-form-group">
                    <label for="localUserUsername">Username *</label>
                    <input type="text" id="localUserUsername" class="admin-input" placeholder="username" autocomplete="off">
                </div>

                <div class="admin-form-group" id="localUserPasswordGroup">
                    <label for="localUserPassword">Password *</label>
                    <input type="password" id="localUserPassword" class="admin-input" placeholder="Password" autocomplete="new-password">
                </div>

                <div class="admin-form-group">
                    <label for="localUserDisplayName">Display Name</label>
                    <input type="text" id="localUserDisplayName" class="admin-input" placeholder="Full Name">
                </div>

                <div class="admin-form-group">
                    <label for="localUserEmail">Email</label>
                    <input type="email" id="localUserEmail" class="admin-input" placeholder="user@example.com">
                </div>

                <div class="admin-form-group">
                    <label>Groups</label>
                    <p class="settings-desc" style="margin-bottom: 8px;">Select groups for access control</p>
                    <div class="admin-group-checkboxes" id="localUserGroups" style="max-height: 150px;">
                        <label class="admin-group-checkbox">
                            <input type="checkbox" value="admin">
                            <span class="admin-group-checkbox-label">admin</span>
                        </label>
                        <label class="admin-group-checkbox">
                            <input type="checkbox" value="lldap_admin">
                            <span class="admin-group-checkbox-label">lldap_admin</span>
                        </label>
                        <label class="admin-group-checkbox">
                            <input type="checkbox" value="users">
                            <span class="admin-group-checkbox-label">users</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="admin-modal-footer">
                <button class="settings-btn" onclick="closeLocalUserModal()">Cancel</button>
                <button class="settings-btn admin-btn-primary" onclick="saveLocalUser()">Save</button>
            </div>
        </div>
    </div>

    <!-- Password Reset Modal -->
    <div class="admin-modal" id="passwordResetModal" role="dialog" aria-modal="true" aria-label="Admin">
        <div class="admin-modal-backdrop" onclick="closePasswordResetModal()"></div>
        <div class="admin-modal-content" style="max-width: 380px;">
            <div class="admin-modal-header">
                <h3>Reset Password</h3>
                <button class="settings-close" onclick="closePasswordResetModal()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="admin-modal-body">
                <input type="hidden" id="passwordResetUserId">
                <p class="settings-desc" style="margin-bottom: 16px;">Enter a new password for <strong id="passwordResetUsername"></strong></p>
                <div class="admin-form-group">
                    <label for="newPasswordInput">New Password *</label>
                    <input type="password" id="newPasswordInput" class="admin-input" placeholder="New password" autocomplete="new-password">
                </div>
                <div class="admin-form-group">
                    <label for="confirmPasswordInput">Confirm Password *</label>
                    <input type="password" id="confirmPasswordInput" class="admin-input" placeholder="Confirm password" autocomplete="new-password">
                </div>
            </div>
            <div class="admin-modal-footer">
                <button class="settings-btn" onclick="closePasswordResetModal()">Cancel</button>
                <button class="settings-btn admin-btn-primary" onclick="resetPassword()">Reset Password</button>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div class="admin-modal" id="apiKeyModal" role="dialog" aria-modal="true" aria-label="Admin">
        <div class="admin-modal-backdrop" onclick="closeAPIKeyModal()"></div>
        <div class="admin-modal-content" style="max-width: 450px;">
            <div class="admin-modal-header">
                <h3 id="apiKeyModalTitle">Create API Key</h3>
                <button class="settings-close" onclick="closeAPIKeyModal()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="admin-modal-body">
                <div id="apiKeyCreateForm">
                    <div class="admin-form-group">
                        <label for="apiKeyName">Key Name *</label>
                        <input type="text" id="apiKeyName" class="admin-input" placeholder="My API Key" autocomplete="off">
                        <p class="settings-desc" style="margin-top: 4px;">A descriptive name to identify this key</p>
                    </div>
                    <div class="admin-form-group">
                        <label for="apiKeyUsername">Username *</label>
                        <input type="text" id="apiKeyUsername" class="admin-input" placeholder="api-user" autocomplete="off">
                        <p class="settings-desc" style="margin-top: 4px;">The username this key authenticates as</p>
                    </div>
                    <div class="admin-form-group">
                        <label for="apiKeyGroups">Groups</label>
                        <input type="text" id="apiKeyGroups" class="admin-input" placeholder="users, api-access" autocomplete="off">
                        <p class="settings-desc" style="margin-top: 4px;">Comma-separated list of groups</p>
                    </div>
                    <div class="admin-form-group">
                        <label for="apiKeyExpiry">Expires In</label>
                        <select id="apiKeyExpiry" class="admin-input">
                            <option value="30">30 days</option>
                            <option value="90">90 days</option>
                            <option value="365" selected>1 year</option>
                            <option value="0">Never</option>
                        </select>
                    </div>
                </div>
                <div id="apiKeyResult" style="display: none;">
                    <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <p class="settings-desc" style="margin-bottom: 8px; color: var(--orange);">
                            <strong>Important:</strong> Copy this key now. You won't be able to see it again!
                        </p>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <code id="apiKeyValue" style="flex: 1; background: var(--bg-secondary); padding: 10px 12px; border-radius: 6px; font-size: 12px; word-break: break-all;"></code>
                            <button class="settings-btn" onclick="copyAPIKey()" style="flex-shrink: 0;">Copy</button>
                        </div>
                    </div>
                    <p class="settings-desc">Use this key in the <code>Authorization</code> header:</p>
                    <code style="display: block; background: var(--bg-tertiary); padding: 10px 12px; border-radius: 6px; font-size: 12px; margin-top: 8px;">Authorization: Bearer YOUR_API_KEY</code>
                </div>
            </div>
            <div class="admin-modal-footer">
                <button class="settings-btn" onclick="closeAPIKeyModal()">Close</button>
                <button class="settings-btn admin-btn-primary" id="createAPIKeyBtn" onclick="createAPIKey()">Create Key</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast" aria-live="polite" role="status"></div>

    <script defer src="/static/js/utils.js?v={{.Version}}"></script>
    <script defer src="/static/js/app.js?v={{.Version}}"></script>
    <script defer src="/static/js/widgets.js?v={{.Version}}"></script>
    <script defer src="/static/js/settings.js?v={{.Version}}"></script>
    <script defer src="/static/js/my-apps.js?v={{.Version}}"></script>
    <script defer src="/static/js/admin.js?v={{.Version}}"></script>
    <script defer src="/static/js/admin-apps.js?v={{.Version}}"></script>
    <script defer src="/static/js/admin-discovery.js?v={{.Version}}"></script>
    <script defer src="/static/js/admin-users.js?v={{.Version}}"></script>
</body>
</html>
